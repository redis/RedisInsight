name: E2E Playwright Tests (v2)

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run tests'
        type: choice
        options:
          - staging
        default: 'staging'
      project:
        description: 'Playwright project to run'
        type: choice
        options:
          - all
          - chromium
          - electron-linux
        default: 'all'
      debug:
        description: 'Enable SSH debugging'
        type: boolean
        default: false

  # Trigger on PR with label (remove and re-add label to rerun)
  pull_request:
    types: [labeled]

  # Nightly schedule (0 AM UTC)
  schedule:
    - cron: '0 0 * * *'

# Cancel in-progress runs for the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  E2E_DIR: './tests/e2e-playwright'
  E2E_CLOUD_DATABASE_USERNAME: ${{ secrets.E2E_CLOUD_DATABASE_USERNAME }}
  E2E_CLOUD_DATABASE_PASSWORD: ${{ secrets.E2E_CLOUD_DATABASE_PASSWORD }}
  E2E_CLOUD_API_ACCESS_KEY: ${{ secrets.E2E_CLOUD_API_ACCESS_KEY }}
  E2E_CLOUD_DATABASE_HOST: ${{ secrets.E2E_CLOUD_DATABASE_HOST }}
  E2E_CLOUD_DATABASE_PORT: ${{ secrets.E2E_CLOUD_DATABASE_PORT }}
  E2E_CLOUD_DATABASE_NAME: ${{ secrets.E2E_CLOUD_DATABASE_NAME }}
  E2E_CLOUD_API_SECRET_KEY: ${{ secrets.E2E_CLOUD_API_SECRET_KEY }}

  E2E_RI_ENCRYPTION_KEY: ${{ secrets.E2E_RI_ENCRYPTION_KEY }}
  RI_ENCRYPTION_KEY: ${{ secrets.E2E_RI_ENCRYPTION_KEY }}
  RI_ENCRYPTION_KEYTAR: 'false'  # Disable keytar to use KEY strategy instead (keytar unavailable on Linux CI)
  # Note: RI_SERVER_TLS_CERT and RI_SERVER_TLS_KEY are intentionally NOT set here
  # Setting them would cause the API server to start in HTTPS mode, which breaks
  # the health check that uses HTTP. These are only needed for TLS-specific tests.
  TEST_BIG_DB_DUMP: ${{ secrets.TEST_BIG_DB_DUMP }}
  E2E_VOLUME_PATH: '/usr/src/app'

jobs:
  # Check if workflow should run (for PR label trigger)
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check trigger conditions
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ contains(github.event.pull_request.labels.*.name, 'e2e-tests') }}" == "true" ]]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
            else
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  # Chromium tests (local dev mode)
  e2e-dev-chromium:
    name: E2E Chromium (Local Dev)
    needs: check-trigger
    if: |
      needs.check-trigger.outputs.should_run == 'true' &&
      (github.event.inputs.project == 'all' || github.event.inputs.project == 'chromium' || github.event.inputs.project == '')
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: Enable SSH Debug
        if: ${{ github.event.inputs.debug == 'true' }}
        uses: mxschmitt/action-tmate@v3
        with:
          detached: true

      - name: Install application dependencies
        uses: ./.github/actions/install-all-build-libs

      - name: Install E2E test dependencies
        working-directory: ${{ env.E2E_DIR }}
        run: yarn install --frozen-lockfile

      - name: Install Playwright browsers
        working-directory: ${{ env.E2E_DIR }}
        run: npx playwright install chromium --with-deps

      - name: Build statics
        run: yarn build:statics

      - name: Build API
        run: yarn --cwd redisinsight/api build

      - name: Start application (dev mode)
        run: |
            yarn dev:api &
            yarn dev:ui &
            # Wait for the app to be ready
            npx wait-on http://localhost:8080 http://localhost:5540/api/health --timeout 60000

      - name: Start Redis test environment
        run: |
          TEST_BIG_DB_DUMP=$TEST_BIG_DB_DUMP \
          docker compose -p e2e-rte -f tests/e2e/rte.docker-compose.yml up --detach --force-recreate

      - name: Run Playwright tests (Chromium)
        working-directory: ${{ env.E2E_DIR }}
        run: npx playwright test --project=chromium
        env:
          CI: true

      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-chromium
          path: |
            ${{ env.E2E_DIR }}/test-results
            ${{ env.E2E_DIR }}/playwright-report
          retention-days: 14

      - name: Stop application
        if: always()
        run: |
          # Kill any node processes running the app
          pkill -f "dist/src/main" || true
          pkill -f "vite dev" || true

      - name: Stop Redis test environment
        if: always()
        run: |
          docker compose -p e2e-rte -f tests/e2e/rte.docker-compose.yml down --volumes --remove-orphans

  # Build Linux AppImage for Electron tests
  build-linux:
    name: Build Linux AppImage
    needs: check-trigger
    if: |
      needs.check-trigger.outputs.should_run == 'true' &&
      (github.event.inputs.project == 'all' || github.event.inputs.project == 'electron-linux' || github.event.inputs.project == '')
    uses: ./.github/workflows/pipeline-build-linux.yml
    secrets: inherit
    with:
      environment: ${{ github.event.inputs.environment || 'staging' }}
      target: 'build_linux_AppImage'
      debug: ${{ github.event.inputs.debug == 'true' }}
      enterprise: false

  # Electron tests (Linux)
  e2e-electron-linux:
    name: E2E Electron (Linux)
    needs: [check-trigger, build-linux]
    if: |
      needs.check-trigger.outputs.should_run == 'true' &&
      (github.event.inputs.project == 'all' || github.event.inputs.project == 'electron-linux' || github.event.inputs.project == '')
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    timeout-minutes: 60
    env:
      # Environment variables needed for Electron/AppImage on Linux (from repository variables)
      DBUS_SESSION_BUS_ADDRESS: ${{ vars.DBUS_SESSION_BUS_ADDRESS }}
      DISPLAY: ${{ vars.DISPLAY }}

    steps:
      - uses: actions/checkout@v4

      - name: Enable SSH Debug
        if: ${{ github.event.inputs.debug == 'true' }}
        uses: mxschmitt/action-tmate@v3
        with:
          detached: true

      - name: Install system dependencies for Electron/AppImage
        run: |
          sudo apt-get update -y
          sudo apt-get install -y kmod libfuse2 xvfb net-tools xdotool desktop-file-utils fluxbox netcat-openbsd

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
          cache-dependency-path: '**/yarn.lock'

      - name: Install E2E test dependencies
        working-directory: ${{ env.E2E_DIR }}
        run: yarn install --frozen-lockfile

      - name: Install Playwright browsers (Electron deps)
        working-directory: ${{ env.E2E_DIR }}
        run: npx playwright install --with-deps

      - name: Download Linux build artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-builds
          path: ./release

      - name: Mount AppImage and get executable path
        id: appimage
        run: |
          ls -la ./release/
          chmod +x ./release/Redis-Insight*.AppImage

          # Get the original AppImage file path
          APPIMAGE_FILE=$(realpath ./release/Redis-Insight*.AppImage | head -1)
          echo "appimage_file=$APPIMAGE_FILE" >> $GITHUB_OUTPUT
          echo "Original AppImage: $APPIMAGE_FILE"

          # Mount the AppImage and capture the mount path
          rm -f appimage_mount_path
          ./release/Redis-Insight*.AppImage --appimage-mount > appimage_mount_path &
          APPIMAGE_PID=$!
          sleep 3

          # Get the mount path and construct the executable path
          MOUNT_PATH=$(cat appimage_mount_path)
          echo "AppImage mounted at: $MOUNT_PATH"
          ls -la "$MOUNT_PATH"

          # The actual electron executable is inside the mounted AppImage
          ELECTRON_PATH="$MOUNT_PATH/redisinsight"
          echo "path=$ELECTRON_PATH" >> $GITHUB_OUTPUT
          echo "pid=$APPIMAGE_PID" >> $GITHUB_OUTPUT
          echo "Found Electron executable: $ELECTRON_PATH"

          # Verify the executable exists
          if [ -f "$ELECTRON_PATH" ]; then
            echo "✓ Electron executable exists"
          else
            echo "✗ Electron executable not found!"
            ls -la "$MOUNT_PATH"
            exit 1
          fi

      - name: Start Redis test environment
        run: |
          TEST_BIG_DB_DUMP=$TEST_BIG_DB_DUMP \
          docker compose -p e2e-rte -f tests/e2e/rte.docker-compose.yml up --detach --force-recreate

      - name: Start Xvfb
        run: |
          # Extract display number from DISPLAY env var (e.g., ":99" -> "99")
          DISPLAY_NUM="${DISPLAY#:}"
          DISPLAY_NUM="${DISPLAY_NUM:-99}"
          echo "Starting Xvfb on display :$DISPLAY_NUM"
          if [ -f /tmp/.X${DISPLAY_NUM}-lock ]; then rm /tmp/.X${DISPLAY_NUM}-lock; fi
          Xvfb :${DISPLAY_NUM} -ac -screen 0 1920x1080x24 &
          sleep 3
          fluxbox &

      - name: Test Electron app launch
        env:
          APPIMAGE: ${{ steps.appimage.outputs.appimage_file }}
        run: |
          echo "=== Testing Electron executable ==="
          echo "Executable path: ${{ steps.appimage.outputs.path }}"
          echo "APPIMAGE env: $APPIMAGE"
          echo "DISPLAY env: $DISPLAY"
          echo "DBUS_SESSION_BUS_ADDRESS env: $DBUS_SESSION_BUS_ADDRESS"
          ls -la ${{ steps.appimage.outputs.path }}

          echo "=== Starting Electron app manually for 15 seconds ==="
          ${{ steps.appimage.outputs.path }} --no-sandbox --disable-gpu &
          ELECTRON_PID=$!
          echo "Electron PID: $ELECTRON_PID"

          sleep 15

          echo "=== Checking if Electron process is running ==="
          ps aux | grep -i redis || echo "No Redis process found"

          echo "=== Checking open ports ==="
          netstat -tlnp 2>/dev/null || ss -tlnp || echo "Could not check ports"

          echo "=== Trying to reach API ==="
          curl -v http://localhost:5530/api/health 2>&1 || echo "API not responding"

          echo "=== Killing test Electron process ==="
          kill $ELECTRON_PID 2>/dev/null || echo "Process already dead"
          sleep 2

      - name: Run Playwright tests (Electron Linux)
        working-directory: ${{ env.E2E_DIR }}
        run: npx playwright test --project=electron
        env:
          CI: true
          ELECTRON_EXECUTABLE_PATH: ${{ steps.appimage.outputs.path }}
          APPIMAGE: ${{ steps.appimage.outputs.appimage_file }}
          RI_SOCKETS_CORS: 'true'
          RI_ENCRYPTION_KEY: ${{ secrets.E2E_RI_ENCRYPTION_KEY }}
          RI_ENCRYPTION_KEYTAR: 'false'

      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-electron-linux
          path: |
            ${{ env.E2E_DIR }}/test-results
            ${{ env.E2E_DIR }}/playwright-report
          retention-days: 14

      - name: Unmount AppImage
        if: always()
        run: |
          # Kill the AppImage mount process
          kill ${{ steps.appimage.outputs.pid }} || true

      - name: Stop Redis test environment
        if: always()
        run: |
          docker compose -p e2e-rte -f tests/e2e/rte.docker-compose.yml down --volumes --remove-orphans
