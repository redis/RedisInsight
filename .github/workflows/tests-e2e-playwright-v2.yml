name: E2E Playwright Tests (v2)

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run tests'
        type: choice
        options:
          - staging
        default: 'staging'
      project:
        description: 'Playwright project to run'
        type: choice
        options:
          - all
          - chromium
          - electron-linux
        default: 'all'
      debug:
        description: 'Enable SSH debugging'
        type: boolean
        default: false

  # Trigger on PR with label (remove and re-add label to rerun)
  pull_request:
    types: [labeled]

  # Nightly schedule (0 AM UTC)
  schedule:
    - cron: '0 0 * * *'

# Cancel in-progress runs for the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '22.12.0'
  E2E_DIR: './tests/e2e-playwright'

jobs:
  # Check if workflow should run (for PR label trigger)
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check trigger conditions
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ contains(github.event.pull_request.labels.*.name, 'e2e-tests') }}" == "true" ]]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
            else
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  # Chromium tests (local dev mode)
  e2e-dev-chromium:
    name: E2E Chromium (Local Dev)
    needs: check-trigger
    if: |
      needs.check-trigger.outputs.should_run == 'true' &&
      (github.event.inputs.project == 'all' || github.event.inputs.project == 'chromium' || github.event.inputs.project == '')
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: Enable SSH Debug
        if: ${{ github.event.inputs.debug == 'true' }}
        uses: mxschmitt/action-tmate@v3
        with:
          detached: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          cache-dependency-path: '**/yarn.lock'

      - name: Install E2E test dependencies
        working-directory: ${{ env.E2E_DIR }}
        run: yarn install --frozen-lockfile

      - name: Install Playwright browsers
        working-directory: ${{ env.E2E_DIR }}
        run: npx playwright install chromium --with-deps

      - name: Install application dependencies
        uses: ./.github/actions/install-all-build-libs
        with:
          skip-system-deps: '1'

      - name: Start Redis test environment
        run: |
          docker compose -p e2e-rte -f tests/e2e/rte.docker-compose.yml up --detach --force-recreate

      - name: Start application (dev mode)
        run: |
          yarn dev:api &
          yarn dev:ui &
          # Wait for the app to be ready
          npx wait-on http://localhost:8080 http://localhost:5540/api/info --timeout 120000

      - name: Run Playwright tests (Chromium)
        working-directory: ${{ env.E2E_DIR }}
        run: npx playwright test --project=chromium
        env:
          CI: true

      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-chromium
          path: |
            ${{ env.E2E_DIR }}/test-results
            ${{ env.E2E_DIR }}/playwright-report
          retention-days: 14

      - name: Stop Redis test environment
        if: always()
        run: |
          docker compose -p e2e-rte -f tests/e2e/rte.docker-compose.yml down --volumes --remove-orphans

  # Build Linux AppImage for Electron tests
  build-linux:
    name: Build Linux AppImage
    needs: check-trigger
    if: |
      needs.check-trigger.outputs.should_run == 'true' &&
      (github.event.inputs.project == 'all' || github.event.inputs.project == 'electron-linux' || github.event.inputs.project == '')
    uses: ./.github/workflows/pipeline-build-linux.yml
    secrets: inherit
    with:
      environment: ${{ github.event.inputs.environment || 'staging' }}
      target: 'build_linux_AppImage'
      debug: ${{ github.event.inputs.debug == 'true' }}
      enterprise: false

  # Electron tests (Linux)
  e2e-electron-linux:
    name: E2E Electron (Linux)
    needs: [check-trigger, build-linux]
    if: |
      needs.check-trigger.outputs.should_run == 'true' &&
      (github.event.inputs.project == 'all' || github.event.inputs.project == 'electron-linux' || github.event.inputs.project == '')
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: Enable SSH Debug
        if: ${{ github.event.inputs.debug == 'true' }}
        uses: mxschmitt/action-tmate@v3
        with:
          detached: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          cache-dependency-path: '**/yarn.lock'

      - name: Install E2E test dependencies
        working-directory: ${{ env.E2E_DIR }}
        run: yarn install --frozen-lockfile

      - name: Install Playwright browsers (Electron deps)
        working-directory: ${{ env.E2E_DIR }}
        run: npx playwright install --with-deps

      - name: Download Linux build artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-builds
          path: ./release

      - name: Make AppImage executable
        run: chmod +x ./release/Redis-Insight*.AppImage

      - name: Start Redis test environment
        run: |
          docker compose -p e2e-rte -f tests/e2e/rte.docker-compose.yml up --detach --force-recreate

      - name: Run Playwright tests (Electron Linux)
        working-directory: ${{ env.E2E_DIR }}
        run: npx playwright test --project=electron
        env:
          CI: true
          ELECTRON_EXECUTABLE_PATH: ${{ github.workspace }}/release/Redis-Insight.AppImage

      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-electron-linux
          path: |
            ${{ env.E2E_DIR }}/test-results
            ${{ env.E2E_DIR }}/playwright-report
          retention-days: 14

      - name: Stop Redis test environment
        if: always()
        run: |
          docker compose -p e2e-rte -f tests/e2e/rte.docker-compose.yml down --volumes --remove-orphans
