name: E2E Playwright Tests (v2)

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run tests'
        type: choice
        options:
          - staging
        default: 'staging'
      project:
        description: 'Playwright project to run'
        type: choice
        options:
          - all
          - chromium
          - electron-linux
        default: 'all'
      debug:
        description: 'Enable SSH debugging'
        type: boolean
        default: false

  # Trigger on PR with label (remove and re-add label to rerun)
  pull_request:
    types: [labeled]

  # Nightly schedule (0 AM UTC)
  schedule:
    - cron: '0 0 * * *'

# Cancel in-progress runs for the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  E2E_DIR: './tests/e2e-playwright'
  E2E_CLOUD_DATABASE_USERNAME: ${{ secrets.E2E_CLOUD_DATABASE_USERNAME }}
  E2E_CLOUD_DATABASE_PASSWORD: ${{ secrets.E2E_CLOUD_DATABASE_PASSWORD }}
  E2E_CLOUD_API_ACCESS_KEY: ${{ secrets.E2E_CLOUD_API_ACCESS_KEY }}
  E2E_CLOUD_DATABASE_HOST: ${{ secrets.E2E_CLOUD_DATABASE_HOST }}
  E2E_CLOUD_DATABASE_PORT: ${{ secrets.E2E_CLOUD_DATABASE_PORT }}
  E2E_CLOUD_DATABASE_NAME: ${{ secrets.E2E_CLOUD_DATABASE_NAME }}
  E2E_CLOUD_API_SECRET_KEY: ${{ secrets.E2E_CLOUD_API_SECRET_KEY }}

  E2E_RI_ENCRYPTION_KEY: ${{ secrets.E2E_RI_ENCRYPTION_KEY }}
  RI_ENCRYPTION_KEY: ${{ secrets.RI_ENCRYPTION_KEY }}
  RI_ENCRYPTION_KEYTAR: 'false'  # Disable keytar to use KEY strategy instead (keytar unavailable on Linux CI)
  # Note: RI_SERVER_TLS_CERT and RI_SERVER_TLS_KEY are intentionally NOT set here
  # Setting them would cause the API server to start in HTTPS mode, which breaks
  # the health check that uses HTTP. These are only needed for TLS-specific tests.
  TEST_BIG_DB_DUMP: ${{ secrets.TEST_BIG_DB_DUMP }}
  E2E_VOLUME_PATH: '/usr/src/app'

jobs:
  # Check if workflow should run (for PR label trigger)
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check trigger conditions
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ contains(github.event.pull_request.labels.*.name, 'e2e-tests') }}" == "true" ]]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
            else
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  # Chromium tests (local dev mode)
  e2e-dev-chromium:
    name: E2E Chromium (Local Dev)
    needs: check-trigger
    if: |
      needs.check-trigger.outputs.should_run == 'true' &&
      (github.event.inputs.project == 'all' || github.event.inputs.project == 'chromium' || github.event.inputs.project == '')
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: Enable SSH Debug
        if: ${{ github.event.inputs.debug == 'true' }}
        uses: mxschmitt/action-tmate@v3
        with:
          detached: true

      - name: Install application dependencies
        uses: ./.github/actions/install-all-build-libs

      - name: Install E2E test dependencies
        working-directory: ${{ env.E2E_DIR }}
        run: yarn install --frozen-lockfile

      - name: Install Playwright browsers
        working-directory: ${{ env.E2E_DIR }}
        run: npx playwright install chromium --with-deps

      - name: Build statics
        run: yarn build:statics

      - name: Build API
        run: yarn --cwd redisinsight/api build

      - name: Start API server
        run: |
          # Run the built API directly (not in watch mode) to avoid potential issues
          # with nest --watch in background/CI environments
          NODE_ENV=development node redisinsight/api/dist/src/main.js > /tmp/api-server.log 2>&1 &
          echo "API server started in background (pid: $!), logging to /tmp/api-server.log"

      - name: Start UI dev server
        run: |
          yarn dev:ui > /tmp/ui-server.log 2>&1 &
          echo "UI server started in background, logging to /tmp/ui-server.log"

      - name: Wait for servers to be ready
        run: |
          echo "Waiting for UI server (http://localhost:8080)..."
          npx wait-on http://localhost:8080 --timeout 120000
          echo "UI server is ready!"

          echo "Waiting for API server (http://127.0.0.1:5540/api/health)..."
          for i in {1..60}; do
            echo "Attempt $i: Checking API health..."
            if curl -s -f http://127.0.0.1:5540/api/health > /dev/null 2>&1; then
              echo "API server is ready!"
              exit 0
            fi
            echo "API not ready yet, waiting 2 seconds..."
            sleep 2
          done
          echo "API server failed to start within 120 seconds"
          exit 1

      - name: Debug - Check server status
        if: ${{ failure() }}
        run: |
          echo "=== API Server Log (last 200 lines) ==="
          tail -200 /tmp/api-server.log || echo "No API log file found"

          echo ""
          echo "=== UI Server Log (last 50 lines) ==="
          tail -50 /tmp/ui-server.log || echo "No UI log file found"

          echo ""
          echo "=== Checking running processes ==="
          ps aux | grep -E "(node|nest|vite)" || true

          echo ""
          echo "=== Checking listening ports ==="
          ss -tlnp | grep -E "(8080|5540)" || netstat -tlnp 2>/dev/null | grep -E "(8080|5540)" || true

          echo ""
          echo "=== Trying to curl the endpoints ==="
          curl -v http://localhost:8080 2>&1 | head -30 || true
          echo ""
          curl -v http://127.0.0.1:5540/api/health 2>&1 | head -50 || true

      - name: Start Redis test environment
        run: |
          docker compose -p e2e-rte -f tests/e2e/rte.docker-compose.yml up --detach --force-recreate

      - name: Run Playwright tests (Chromium)
        working-directory: ${{ env.E2E_DIR }}
        run: npx playwright test --project=chromium
        env:
          CI: true

      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-chromium
          path: |
            ${{ env.E2E_DIR }}/test-results
            ${{ env.E2E_DIR }}/playwright-report
          retention-days: 14

      - name: Stop application
        if: always()
        run: |
          # Kill any node processes running the app
          pkill -f "dist/src/main" || true
          pkill -f "vite dev" || true

      - name: Stop Redis test environment
        if: always()
        run: |
          docker compose -p e2e-rte -f tests/e2e/rte.docker-compose.yml down --volumes --remove-orphans

  # Build Linux AppImage for Electron tests
  build-linux:
    name: Build Linux AppImage
    needs: check-trigger
    if: |
      needs.check-trigger.outputs.should_run == 'true' &&
      (github.event.inputs.project == 'all' || github.event.inputs.project == 'electron-linux' || github.event.inputs.project == '')
    uses: ./.github/workflows/pipeline-build-linux.yml
    secrets: inherit
    with:
      environment: ${{ github.event.inputs.environment || 'staging' }}
      target: 'build_linux_AppImage'
      debug: ${{ github.event.inputs.debug == 'true' }}
      enterprise: false

  # Electron tests (Linux)
  e2e-electron-linux:
    name: E2E Electron (Linux)
    needs: [check-trigger, build-linux]
    if: |
      needs.check-trigger.outputs.should_run == 'true' &&
      (github.event.inputs.project == 'all' || github.event.inputs.project == 'electron-linux' || github.event.inputs.project == '')
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: Enable SSH Debug
        if: ${{ github.event.inputs.debug == 'true' }}
        uses: mxschmitt/action-tmate@v3
        with:
          detached: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
          cache-dependency-path: '**/yarn.lock'

      - name: Install E2E test dependencies
        working-directory: ${{ env.E2E_DIR }}
        run: yarn install --frozen-lockfile

      - name: Install Playwright browsers (Electron deps)
        working-directory: ${{ env.E2E_DIR }}
        run: npx playwright install --with-deps

      - name: Download Linux build artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-builds
          path: ./release

      - name: Make AppImage executable
        run: chmod +x ./release/Redis-Insight*.AppImage

      - name: Start Redis test environment
        run: |
          docker compose -p e2e-rte -f tests/e2e/rte.docker-compose.yml up --detach --force-recreate

      - name: Run Playwright tests (Electron Linux)
        working-directory: ${{ env.E2E_DIR }}
        run: npx playwright test --project=electron
        env:
          CI: true
          ELECTRON_EXECUTABLE_PATH: ${{ github.workspace }}/release/Redis-Insight.AppImage

      - name: Upload test results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-electron-linux
          path: |
            ${{ env.E2E_DIR }}/test-results
            ${{ env.E2E_DIR }}/playwright-report
          retention-days: 14

      - name: Stop Redis test environment
        if: always()
        run: |
          docker compose -p e2e-rte -f tests/e2e/rte.docker-compose.yml down --volumes --remove-orphans
